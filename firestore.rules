rules_version = '2';

// Firestore Security Rules for TwilightGame
// Deploy with: firebase deploy --only firestore:rules
//
// Data Structure:
// - users/{userId}                           - User profile (displayName, email, settings)
// - users/{userId}/saves/{slotId}            - Save slot with metadata
// - users/{userId}/saves/{slotId}/data/{doc} - Save data documents

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // User Documents
    // ============================================
    match /users/{userId} {
      // User profile document - contains displayName, email, settings
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUserProfile();
      allow update: if isOwner(userId) && isValidUserProfileUpdate();
      allow delete: if false; // Users cannot delete their own profile

      // ============================================
      // Save Slots Collection
      // ============================================
      match /saves/{slotId} {
        // Save slot document - contains metadata (characterName, lastSaved, etc.)
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && isValidSaveMetadata();
        allow update: if isOwner(userId) && isValidSaveMetadata();
        allow delete: if isOwner(userId);

        // ============================================
        // Save Data Documents
        // ============================================
        match /data/{docType} {
          allow read: if isOwner(userId);
          allow write: if isOwner(userId) && isValidSaveDataType(docType);
        }
      }
    }

    // ============================================
    // Helper Functions
    // ============================================

    // Check if the requesting user owns this data
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Validate user profile structure
    function isValidUserProfile() {
      let data = request.resource.data;
      return data.keys().hasAll(['displayName']) &&
             data.displayName is string &&
             data.displayName.size() <= 50;
    }

    // Validate user profile update (allow partial updates)
    function isValidUserProfileUpdate() {
      let data = request.resource.data;
      // If displayName is present, validate it
      return (!('displayName' in data) || (data.displayName is string && data.displayName.size() <= 50));
    }

    // Validate save slot metadata
    function isValidSaveMetadata() {
      let data = request.resource.data;
      // Required fields for save metadata
      return data.keys().hasAll(['characterName', 'version']) &&
             data.characterName is string &&
             data.characterName.size() <= 50 &&
             data.version is string;
    }

    // Validate save data document types
    function isValidSaveDataType(docType) {
      return docType in [
        'character',
        'inventory',
        'farming',
        'cooking',
        'magic',
        'friendships',
        'quests',
        'world',
        'stats'
      ];
    }

    // ============================================
    // Default: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
