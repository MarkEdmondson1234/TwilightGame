rules_version = '2';

// Firestore Security Rules for TwilightGame
// Deploy with: firebase deploy --only firestore:rules
//
// Data Structure:
// - users/{userId}                              - User profile
// - users/{userId}/meta/sync                    - Sync metadata
// - users/{userId}/saves/{slotId}               - Save slot with metadata
// - users/{userId}/saves/{slotId}/data/{doc}    - Save data documents
// - users/{userId}/paintings/{paintingId}        - Painting image data
// - conversations/{npcId}/summaries/{id}         - Shared conversation summaries
// - sharedEvents/{eventId}                      - Shared world events
// - shared/farming/plots/{plotId}               - Shared farm plots (village + farm_area)

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // User Documents (Private)
    // ============================================
    match /users/{userId} {
      // User profile document
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUserProfile();
      allow update: if isOwner(userId) && isValidUserProfileUpdate();
      allow delete: if false; // Users cannot delete their own profile

      // Sync metadata subcollection
      match /meta/{metaDoc} {
        allow read, write: if isOwner(userId);
      }

      // Paintings subcollection (base64 image data)
      match /paintings/{paintingId} {
        allow read, write: if isOwner(userId);
      }

      // Diary entries subcollection (conversation summaries)
      match /diary/{entryId} {
        allow read, write: if isOwner(userId);
      }

      // Save slots collection
      match /saves/{slotId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && isValidSaveMetadata();
        allow update: if isOwner(userId) && isValidSaveMetadata();
        allow delete: if isOwner(userId);

        // Save data documents
        match /data/{docType} {
          allow read: if isOwner(userId);
          allow write: if isOwner(userId) && isValidSaveDataType(docType);
        }
      }
    }

    // ============================================
    // Shared Data (Public Read, Authenticated Write)
    // ============================================

    // Shared conversations - what players discussed with NPCs
    // Path: conversations/{npcId}/summaries/{summaryId}
    match /conversations/{npcId}/summaries/{summaryId} {
      // Anyone can read conversation summaries
      allow read: if true;

      // Only authenticated users can write, with validation
      allow create: if isAuthenticated() && isValidConversationSummary();

      // Immutable (no updates), admins can delete for moderation
      allow update: if false;
      allow delete: if isAdmin();
    }

    // Shared farm plots - collaborative farming on village + farm_area maps
    // Path: shared/farming/plots/{plotId}
    match /shared/farming/plots/{plotId} {
      // Any authenticated user can read shared plots
      allow read: if isAuthenticated();

      // Create/update require valid plot data
      allow create, update: if isAuthenticated() && isValidSharedPlot();

      // Delete only requires authentication (no request.resource.data on delete)
      allow delete: if isAuthenticated();
    }

    // Shared world events - discoveries, achievements, etc.
    // Path: sharedEvents/{eventId}
    match /sharedEvents/{eventId} {
      // Anyone can read events
      allow read: if true;

      // Only authenticated users can write, with validation
      allow create: if isAuthenticated() && isValidWorldEvent();

      // Immutable (no updates), admins can delete for moderation
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ============================================
    // Helper Functions
    // ============================================

    // Check if the requesting user owns this data
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is an admin (email whitelist)
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email != null &&
             request.auth.token.email in [
               'me@markedmondson.me',
               'sanneharder@gmail.com'
             ];
    }

    // Validate user profile structure
    function isValidUserProfile() {
      let data = request.resource.data;
      return data.keys().hasAll(['displayName']) &&
             data.displayName is string &&
             data.displayName.size() <= 50;
    }

    // Validate user profile update (allow partial updates)
    function isValidUserProfileUpdate() {
      let data = request.resource.data;
      return (!('displayName' in data) || (data.displayName is string && data.displayName.size() <= 50));
    }

    // Validate save slot metadata
    function isValidSaveMetadata() {
      let data = request.resource.data;
      return data.keys().hasAll(['characterName', 'version']) &&
             data.characterName is string &&
             data.characterName.size() <= 50 &&
             data.version is string;
    }

    // Validate save data document types
    function isValidSaveDataType(docType) {
      return docType in [
        'character',
        'inventory',
        'farming',
        'cooking',
        'magic',
        'friendships',
        'quests',
        'world',
        'stats',
        'decoration',
        'conversations'
      ];
    }

    // Validate conversation summary
    function isValidConversationSummary() {
      let data = request.resource.data;
      return data.keys().hasAll(['npcId', 'npcName', 'topic', 'summary', 'contributorId']) &&
             data.npcId is string &&
             data.npcName is string &&
             data.npcName.size() <= 50 &&
             data.topic is string &&
             data.topic.size() <= 100 &&
             data.summary is string &&
             data.summary.size() <= 1000 &&
             data.contributorId is string;
    }

    // Validate shared farm plot
    function isValidSharedPlot() {
      let data = request.resource.data;
      return data.keys().hasAll(['mapId', 'x', 'y', 'state', 'stateChangedAtTimestamp']) &&
             data.mapId is string &&
             data.mapId in ['village', 'farm_area'] &&
             data.x is int &&
             data.y is int &&
             data.state is int;
    }

    // Validate world event
    function isValidWorldEvent() {
      let data = request.resource.data;
      return data.keys().hasAll(['eventType', 'title', 'description', 'contributorId']) &&
             data.eventType in ['discovery', 'achievement', 'seasonal', 'community', 'mystery'] &&
             data.title is string &&
             data.title.size() <= 100 &&
             data.description is string &&
             data.description.size() <= 500 &&
             data.contributorId is string;
    }

    // ============================================
    // Default: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
